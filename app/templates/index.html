<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simptions Intelligent Paper Generator</title>
    
    <!-- Bootstrap CSS & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* ---COLOR PALETTE & THEME --- */
        :root {
            --primary-color: #00796b; /* Deep Teal */
            --accent-color: #ffab40;  /* Amber/Gold */
            --background-color: #f5f7fa;
            --card-bg-color: #ffffff;
            --text-color: #334155;
            --text-light: #64748b;
            --border-color: #e2e8f0;
            --shadow-color: rgba(100, 116, 139, 0.12);
            --easy-color: #22c55e;
            --medium-color: #3b82f6;
            --hard-color: #ef4444;
        }

        [data-bs-theme="dark"] {
            --primary-color: #26a69a;
            --accent-color: #ffd180;
            --background-color: #0f172a;
            --card-bg-color: #1e293b;
            --text-color: #cbd5e1;
            --text-light: #94a3b8;
            --border-color: #334155;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --easy-color: #4ade80;
            --medium-color: #60a5fa;
            --hard-color: #f87171;
        }

        body {
            background-color: var(--background-color);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23dce4f0' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
        }
        
        [data-bs-theme="dark"] body {
             background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23334155' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .main-card, .summary-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color);
        }
        .main-card .card-header {
            background: transparent;
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 1.75rem;
        }

        .form-step { display: none; animation: fadeIn 0.5s ease-out; }
        .form-step.active { display: block; }
        .form-label { font-weight: 600; color: var(--text-light); font-size: 0.9rem; }
        .form-control, .form-select {
            border-radius: 8px;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            font-weight: 600;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent);
            background-color: var(--card-bg-color);
        }
        .form-control.is-invalid, .form-select.is-invalid {
            border-color: #dc3545;
            animation: shake 0.4s;
        }
        
        .btn { border-radius: 8px; padding: 12px 25px; font-weight: 700; transition: all 0.2s ease; border: none; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: color-mix(in srgb, var(--primary-color) 90%, black); transform: translateY(-2px); }
        .btn-success { background-color: var(--accent-color); color: #1e293b; }
        .btn-success:hover { background-color: color-mix(in srgb, var(--accent-color) 90%, black); transform: translateY(-2px); }
        .progress { height: 10px; border-radius: 5px; background-color: var(--border-color); }
        .progress-bar { background-color: var(--accent-color); transition: width 0.5s ease-in-out; }

        .summary-card { position: sticky; top: 2.5rem; }
        .summary-card .card-header { font-weight: 700; color: var(--text-color); background: transparent; text-align: center; font-size: 1.1rem; }
        .summary-list .list-group-item { background-color: transparent; border: none; padding: 0.85rem 0.25rem; display: flex; justify-content: space-between; align-items: center; }
        .summary-list .list-group-item i { color: var(--primary-color); margin-right: 12px; font-size: 1.1rem; }
        .summary-value { font-weight: 700; color: var(--text-color); text-align: right; }
        #summaryTotalMarks { font-size: 2.25rem; color: var(--primary-color); font-weight: 700; }
        
        .question-type-group { padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--background-color); }

        /* --- NEW DISTRIBUTION BAR STYLES --- */
        .distribution-bar-container {
            padding: 2rem 0;
        }
        .distribution-bar {
            position: relative;
            width: 100%;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 10px;
            display: flex;
        }
        .dist-segment {
            height: 100%;
            transition: width 0.1s;
        }
        .dist-segment.easy { background-color: var(--easy-color); border-radius: 10px 0 0 10px;}
        .dist-segment.medium { background-color: var(--medium-color); }
        .dist-segment.hard { background-color: var(--hard-color); border-radius: 0 10px 10px 0;}
        
        .dist-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            background-color: var(--card-bg-color);
            border: 3px solid var(--primary-color);
            border-radius: 50%;
            cursor: ew-resize;
            z-index: 10;
        }
        .dist-handle:hover {
            box-shadow: 0 0 0 6px color-mix(in srgb, var(--primary-color) 20%, transparent);
        }
        .dist-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }
        .dist-label { font-weight: 600; }
        .dist-label .badge { font-size: 0.9rem; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>
    <!-- Theme toggle switch for light/dark mode -->
    <div class="form-check form-switch position-fixed top-0 end-0 m-3 p-3" style="z-index: 1050;">
        <input class="form-check-input" type="checkbox" role="switch" id="themeToggle" style="cursor: pointer;">
        <label class="form-check-label" for="themeToggle"><i class="bi bi-moon-stars-fill"></i></label>
    </div>

    <div class="container my-5">
        <!-- Main heading and subheading for the application -->
        <div class="text-center mb-5">
            <h1 class="display-5 fw-bold" style="color: var(--text-color);">Intelligent Paper Generator</h1>
            <p class="lead" style="color: var(--text-light);">The smartest way to build assessments.</p>
        </div>

        <div class="row g-5">
            <!-- Main Form Column -->
            <div class="col-lg-8">
                <div class="main-card">
                    <div class="card-header">
                        <!-- Progress bar to show completion status -->
                        <div class="progress"><div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;"></div></div>
                    </div>
                    <div class="card-body p-4 p-md-5">
                        <form id="paperGenerationForm" novalidate>
                            <!-- Step 1: Core Details of the paper -->
                            <div class="form-step active" id="step1">
                                <h4 class="mb-4 fw-bold">Step 1: Core Details</h4>
                                <div class="row g-4">
                                    <div class="col-12"><label for="schoolName" class="form-label">School Name</label><input type="text" class="form-control" id="schoolName" placeholder="e.g., Delhi Public School" required></div>
                                    <div class="col-md-6"><label for="schoolBoard" class="form-label">School Board</label><select id="schoolBoard" class="form-select" required><option selected disabled value="">Choose...</option><option value="CBSE">CBSE</option><option value="ICSE">ICSE</option><option value="State Board">State Board</option></select></div>
                                    <div class="col-md-6"><label for="classSelect" class="form-label">Class</label><select id="classSelect" class="form-select" required><option selected disabled value="">Choose...</option></select></div>
                                    <div class="col-12"><label for="subjectSelect" class="form-label">Subject</label><select id="subjectSelect" class="form-select" required disabled><option selected disabled value="">Waiting for class...</option></select></div>
                                </div>
                                <div class="d-flex justify-content-end mt-5"><button type="button" class="btn btn-primary next-step">Next <i class="bi bi-arrow-right"></i></button></div>
                            </div>

                            <!-- Step 2: Question types and their marks -->
                            <div class="form-step" id="step2">
                                <h4 class="mb-4 fw-bold">Step 2: Question & Marks Distribution</h4>
                                <div class="row g-4" id="question-distribution-container">
                                    <!-- Question type groups will be dynamically inserted here -->
                                </div>
                                <div class="d-flex justify-content-between mt-5"><button type="button" class="btn btn-outline-secondary prev-step"><i class="bi bi-arrow-left"></i> Previous</button><button type="button" class="btn btn-primary next-step">Next <i class="bi bi-arrow-right"></i></button></div>
                            </div>

                            <!-- Step 3: Difficulty distribution and final submission -->
                            <div class="form-step" id="step3">
                                <h4 class="mb-4 fw-bold">Step 3: Difficulty Distribution</h4>
                                <div class="distribution-bar-container">
                                    <div class="dist-labels">
                                        <div class="dist-label text-success">Easy: <span class="badge text-bg-success" id="easyValue">40%</span></div>
                                        <div class="dist-label text-primary">Medium: <span class="badge text-bg-primary" id="mediumValue">40%</span></div>
                                        <div class="dist-label text-danger">Hard: <span class="badge text-bg-danger" id="hardValue">20%</span></div>
                                    </div>
                                    <div class="distribution-bar mt-2" id="distributionBar">
                                        <div class="dist-segment easy" id="easySegment"></div>
                                        <div class="dist-segment medium" id="mediumSegment"></div>
                                        <div class="dist-segment hard" id="hardSegment"></div>
                                        <div class="dist-handle" id="handle1" style="left: 40%;"></div>
                                        <div class="dist-handle" id="handle2" style="left: 80%;"></div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between mt-5"><button type="button" class="btn btn-outline-secondary prev-step"><i class="bi bi-arrow-left"></i> Previous</button><button type="submit" class="btn btn-success btn-lg"><i class="bi bi-stars me-2"></i>Generate Paper</button></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Live Summary Column -->
            <div class="col-lg-4">
                <div class="summary-card">
                    <div class="card-header"><i class="bi bi-clipboard-data me-2"></i>Live Preview</div>
                    <div class="card-body p-4">
                        <ul class="list-group list-group-flush summary-list">
                            <li class="list-group-item"><i class="bi bi-building"></i><span>School</span> <span id="summarySchool" class="summary-value">...</span></li>
                            <li class="list-group-item"><i class="bi bi-journal-check"></i><span>Board</span> <span id="summaryBoard" class="summary-value">...</span></li>
                            <li class="list-group-item"><i class="bi bi-person-video2"></i><span>Class</span> <span id="summaryClass" class="summary-value">...</span></li>
                            <li class="list-group-item"><i class="bi bi-book-half"></i><span>Subject</span> <span id="summarySubject" class="summary-value">...</span></li>
                            <li class="list-group-item"><i class="bi bi-question-circle"></i><span>Questions</span> <span id="summaryTotalQuestions" class="summary-value">0</span></li>
                            <li class="list-group-item flex-column align-items-center pt-3"><strong class="fs-6 text-uppercase" style="color: var(--text-light);">Total Marks</strong><strong id="summaryTotalMarks">0</strong></li>
                        </ul>
                        <div class="d-grid mt-4"><button type="button" class="btn btn-outline-primary"><i class="bi bi-save me-2"></i>Save as Template</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC (WITH DISTRIBUTION BAR) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENT SELECTION ---
            const form = document.getElementById('paperGenerationForm');
            const steps = Array.from(document.querySelectorAll('.form-step'));
            const progressBar = document.getElementById('progressBar');
            const themeToggle = document.getElementById('themeToggle');
            let currentStep = 0;

            // --- DATA AND CONFIGURATION ---
            const subjects = {
                junior: ['English', 'Hindi', 'Mathematics', 'Science', 'Social Studies', 'Computer Science'],
                senior: ['English', 'Physics', 'Chemistry', 'Biology', 'Mathematics', 'Accountancy', 'Business Studies', 'Economics', 'History', 'Computer Science']
            };
            const questionTypes = [
                { id: 'MCQ', label: 'Multiple Choice', defaultMarks: 1 },
                { id: 'Fill', label: 'Fill in the Blanks', defaultMarks: 1 },
                { id: 'Short', label: 'Short Answer', defaultMarks: 3 },
                { id: 'Long', label: 'Long Answer', defaultMarks: 5 },
                { id: 'Match', label: 'Matching', defaultMarks: 4 },
                { id: 'Case', label: 'Case Study', defaultMarks: 5 }
            ];

            // --- CORE FUNCTIONS ---

            /**
             * Validates all required fields in a given step.
             * @param {number} stepIndex - The index of the step to validate.
             * @returns {boolean} - True if the step is valid, false otherwise.
             */
            const validateStep = (stepIndex) => {
                const currentStepDiv = steps[stepIndex];
                const inputs = currentStepDiv.querySelectorAll('input[required], select[required]');
                let isValid = true;
                inputs.forEach(input => {
                    if (!input.value || input.value === "") {
                        isValid = false;
                        input.classList.add('is-invalid');
                    } else {
                        input.classList.remove('is-invalid');
                    }
                });
                return isValid;
            };

            /**
             * Updates the progress bar based on the current step.
             */
            const updateProgressBar = () => {
                const progress = (currentStep / (steps.length - 1)) * 100;
                progressBar.style.width = `${progress}%`;
            };

            /**
             * Shows a specific step in the form.
             * @param {number} stepIndex - The index of the step to show.
             */
            const showStep = (stepIndex) => {
                if (stepIndex > currentStep && !validateStep(currentStep)) {
                    return; 
                }
                steps.forEach((step, index) => {
                    step.classList.toggle('active', index === stepIndex);
                });
                currentStep = stepIndex;
                updateProgressBar();
            };

            /**
             * Updates the summary panel with the latest form data.
             */
            const updateSummary = () => {
                const summaryFields = {
                    school: document.getElementById('summarySchool'),
                    board: document.getElementById('summaryBoard'),
                    class: document.getElementById('summaryClass'),
                    subject: document.getElementById('summarySubject'),
                    totalQuestions: document.getElementById('summaryTotalQuestions'),
                    totalMarks: document.getElementById('summaryTotalMarks')
                };
                
                summaryFields.school.textContent = document.getElementById('schoolName').value || '...';
                summaryFields.board.textContent = document.getElementById('schoolBoard').value || '...';
                summaryFields.class.textContent = document.getElementById('classSelect').value || '...';
                const subjectSelect = document.getElementById('subjectSelect');
                summaryFields.subject.textContent = subjectSelect.options[subjectSelect.selectedIndex]?.text || '...';
                
                let totalQuestions = 0, totalMarks = 0;
                document.querySelectorAll('.question-type-group').forEach(group => {
                    const count = parseInt(group.querySelector('.question-count').value) || 0;
                    const marks = parseInt(group.querySelector('.marks-per-question').value) || 0;
                    totalQuestions += count;
                    totalMarks += count * marks;
                });
                summaryFields.totalQuestions.textContent = totalQuestions;
                summaryFields.totalMarks.textContent = totalMarks;
            };

            // --- EVENT LISTENERS ---

            // Use event delegation for next/prev buttons
            form.addEventListener('click', (e) => {
                if (e.target.matches('.next-step')) {
                    if (currentStep < steps.length - 1) showStep(currentStep + 1);
                }
                if (e.target.matches('.prev-step')) {
                    if (currentStep > 0) showStep(currentStep - 1);
                }
            });

            // Remove invalid status on input
            form.addEventListener('input', (e) => {
                if (e.target.matches('input[required], select[required]')) {
                    if (e.target.value && e.target.value !== "") {
                        e.target.classList.remove('is-invalid');
                    }
                }
                // Update summary on any form input
                updateSummary();
            });

            // Handle dynamic subjects based on class selection
            const classSelect = document.getElementById('classSelect');
            classSelect.addEventListener('change', () => {
                const subjectSelect = document.getElementById('subjectSelect');
                const selectedClass = parseInt(classSelect.value);
                const subjectList = (selectedClass >= 1 && selectedClass <= 10) ? subjects.junior : subjects.senior;
                subjectSelect.innerHTML = '<option selected disabled value="">Choose...</option>';
                subjectList.forEach(subject => {
                    const option = new Option(subject, subject.toLowerCase().replace(/ /g, '_'));
                    subjectSelect.add(option);
                });
                subjectSelect.disabled = false;
            });

            // Handle form submission
            form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const payload = {
        schoolName: document.getElementById('schoolName').value.trim(),
        schoolBoard: document.getElementById('schoolBoard').value,
        class: document.getElementById('classSelect').value,
        subject: document.getElementById('subjectSelect').options[document.getElementById('subjectSelect').selectedIndex].text,
        questionDistribution: {},
        difficultyDistribution: {}
    };

    document.querySelectorAll('.question-type-group').forEach(group => {
        const label = group.querySelector('.form-label.fw-bold').textContent.trim();
        const count = parseInt(group.querySelector('.question-count').value || '0', 10);
        const marks = parseInt(group.querySelector('.marks-per-question').value || '1', 10);
        if (count > 0) {
            payload.questionDistribution[label] = { count, marks };
        }
    });

    const easy = parseInt(document.getElementById('easyValue').textContent.replace('%',''), 10);
    const medium = parseInt(document.getElementById('mediumValue').textContent.replace('%',''), 10);
    const hard = parseInt(document.getElementById('hardValue').textContent.replace('%',''), 10);
    payload.difficultyDistribution = { Easy: easy, Medium: medium, Hard: hard };

    try {
        const res = await fetch('/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error('API error ' + res.status);
        const data = await res.json();
        renderGeneratedPaper(data);
    } catch (err) {
        alert('Error: ' + err.message);
    }
});

function renderGeneratedPaper(data) {
    let container = document.getElementById('generatedPaper');
    if (!container) {
        container = document.createElement('div');
        container.id = 'generatedPaper';
        container.className = 'container my-4';
        document.body.appendChild(container);
    }
    const { summary, questions, pdf_url } = data || {};
    container.innerHTML = `
    <h3>Generated Paper</h3>
    <p><strong>Total Questions:</strong> ${summary?.total_questions || 0}</p>
    <p><strong>Total Marks:</strong> ${summary?.total_marks || 0}</p>
    <ol>
        ${(questions || []).map(q => `<li>${q.type} (${q.marks} marks) [${q.difficulty}] - ${q.question}</li>`).join('')}
    </ol>
    <div class="mt-4">
        <a href="${data.pdf_url}" class="btn btn-primary" download>📥 Download PDF</a>
    </div>
`;


    // Show download button if backend sent a pdf_url
    if (pdf_url) {
        const pdfSection = document.getElementById('pdf-download');
        const pdfLink = document.getElementById('pdf-link');
        pdfLink.href = pdf_url;
        pdfSection.style.display = "block";
    }
}



            // Theme toggle
            themeToggle.addEventListener('change', () => {
                document.documentElement.setAttribute('data-bs-theme', themeToggle.checked ? 'dark' : 'light');
            });

            // --- INITIALIZATION ---

            // Dynamically populate class dropdown
            for (let i = 1; i <= 12; i++) {
                classSelect.add(new Option(i, i));
            }

            // Dynamically create question type inputs
            const questionContainer = document.getElementById('question-distribution-container');
            questionContainer.innerHTML = questionTypes.map(q => `
                <div class="col-md-6 question-type-group">
                    <label class="form-label fw-bold">${q.label}</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="input-group">
                                <span class="input-group-text">#</span>
                                <input type="number" class="form-control question-count" id="num${q.id}" value="0" min="0" required>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="input-group">
                                <span class="input-group-text">Marks</span>
                                <input type="number" class="form-control marks-per-question" id="marks${q.id}" value="${q.defaultMarks}" min="1" required>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Initialize the first step and summary
            showStep(0);
            updateSummary();

            // --- DISTRIBUTION BAR LOGIC ---
            const distBar = document.getElementById('distributionBar');
            const handle1 = document.getElementById('handle1');
            const handle2 = document.getElementById('handle2');
            const easySegment = document.getElementById('easySegment');
            const mediumSegment = document.getElementById('mediumSegment');
            const hardSegment = document.getElementById('hardSegment');
            const easyValue = document.getElementById('easyValue');
            const mediumValue = document.getElementById('mediumValue');
            const hardValue = document.getElementById('hardValue');

            function updateDistribution() {
                const p1 = parseFloat(handle1.style.left);
                const p2 = parseFloat(handle2.style.left);
                
                const easyPercent = Math.round(p1);
                const mediumPercent = Math.round(p2 - p1);
                const hardPercent = 100 - easyPercent - mediumPercent;

                easySegment.style.width = `${easyPercent}%`;
                mediumSegment.style.width = `${mediumPercent}%`;
                hardSegment.style.width = `${hardPercent}%`;

                easyValue.textContent = `${easyPercent}%`;
                mediumValue.textContent = `${mediumPercent}%`;
                hardValue.textContent = `${hardPercent}%`;
            }

            function makeDraggable(handle) {
                let isDragging = false;
                handle.addEventListener('mousedown', () => { isDragging = true; document.body.style.cursor = 'ew-resize'; });
                document.addEventListener('mouseup', () => { isDragging = false; document.body.style.cursor = 'auto'; });
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    const rect = distBar.getBoundingClientRect();
                    let percent = ((e.clientX - rect.left) / rect.width) * 100;
                    percent = Math.max(0, Math.min(100, percent));
                    
                    if (handle === handle1) {
                        percent = Math.min(percent, parseFloat(handle2.style.left));
                    } else {
                        percent = Math.max(percent, parseFloat(handle1.style.left));
                    }
                    
                    handle.style.left = `${percent}%`;
                    updateDistribution();
                });
            }

            makeDraggable(handle1);
            makeDraggable(handle2);
            updateDistribution();
        });
    </script>


     <!-- PDF Download Button -->
    <div id="pdf-download" class="text-center my-4" style="display: none;">
        <a id="pdf-link" href="#" target="_blank" class="btn btn-primary btn-lg">
            📄 Download Question Paper (PDF)
        </a>
    </div>


</body>
</html>
